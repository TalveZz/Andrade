<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>AR IFRJ GESTÃO TI - Zoom e Troca Câmera Mobile</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
      #fullscreenBtn,
      #cameraSwitcher,
      #zoomSlider {
        font-size: 22px !important;
        padding: 14px 20px !important;
        border-radius: 10px !important;
        background: #222;
        color: white;
        opacity: 0.9;
        border: none;
        user-select: none;
        z-index: 101;
        position: fixed;
        right: 15px;
      }

      #fullscreenBtn {
        bottom: 15px;
      }

      #cameraSwitcher {
        bottom: 70px;
        width: 140px;
      }

      #zoomSlider {
        bottom: 120px;
        width: 140px;
      }

      @media (max-width: 600px) {
        #fullscreenBtn,
        #cameraSwitcher,
        #zoomSlider {
          width: 90vw;
          right: 5vw;
          font-size: 26px !important;
          padding: 18px;
        }

        #cameraSwitcher {
          bottom: 90px;
        }

        #zoomSlider {
          bottom: 150px;
        }
      }
    </style>
  </head>
  <body style="margin: 0; overflow: hidden; background: #000;">
    <button id="fullscreenBtn" onclick="launchFullscreen()">Tela cheia</button>
    <button id="cameraSwitcher" disabled>Trocar Câmera</button>
    <input
      type="range"
      id="zoomSlider"
      min="1"
      max="3"
      step="0.1"
      value="1"
      disabled
    />

    <a-scene embedded stats vr-mode-ui="enabled: false" id="arScene">
      <a-marker type="pattern" url="arc.patt">
        <a-entity gltf-model="logo.glb" position="0 0 0" scale="0.08 0.08 0.08"></a-entity>
      </a-marker>

      <a-marker type="pattern" url="wev.patt">
        <a-entity gltf-model="modelwev.glb" position="0 0 0" scale="0.08 0.08 0.08"></a-entity>
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
      let videoDevices = [];
      let currentDeviceIndex = 0;
      let stream = null;

      const switcherBtn = document.getElementById("cameraSwitcher");
      const zoomSlider = document.getElementById("zoomSlider");

      function launchFullscreen() {
        const el = document.querySelector("a-scene");
        if (el.requestFullscreen) el.requestFullscreen();
        else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
        else if (el.mozRequestFullScreen) el.mozRequestFullScreen();
        else if (el.msRequestFullscreen) el.msRequestFullscreen();
      }

      async function startARWithDevice(deviceId, zoomValue = 1) {
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
        }

        try {
          const constraints = {
            video: { deviceId: { exact: deviceId } },
            audio: false,
          };

          stream = await navigator.mediaDevices.getUserMedia(constraints);

          // Aplica zoom se suportado
          const [videoTrack] = stream.getVideoTracks();
          const capabilities = videoTrack.getCapabilities();
          if (capabilities.zoom) {
            const zoomConstraint =
              zoomValue >= capabilities.min && zoomValue <= capabilities.max
                ? { zoom: zoomValue }
                : { zoom: capabilities.min };
            await videoTrack.applyConstraints(zoomConstraint);
          }

          // Atualiza atributo do arjs para trocar a câmera
          const sceneEl = document.querySelector("#arScene");
          sceneEl.setAttribute("arjs", {
            sourceType: "webcam",
            sourceId: deviceId,
          });

          console.log(`Câmera ativada: ${deviceId} com zoom ${zoomValue}`);
        } catch (e) {
          console.error("Erro ao iniciar câmera:", e);
        }
      }

      async function init() {
        const devices = await navigator.mediaDevices.enumerateDevices();
        videoDevices = devices.filter((d) => d.kind === "videoinput");

        if (videoDevices.length === 0) {
          alert("Nenhuma câmera detectada.");
          return;
        }

        switcherBtn.disabled = false;
        zoomSlider.disabled = false;

        // Começa com a câmera principal (geralmente a traseira - última da lista)
        currentDeviceIndex = videoDevices.length - 1;
        await startARWithDevice(videoDevices[currentDeviceIndex].deviceId);

        switcherBtn.onclick = async () => {
          currentDeviceIndex = (currentDeviceIndex + 1) % videoDevices.length;
          await startARWithDevice(
            videoDevices[currentDeviceIndex].deviceId,
            parseFloat(zoomSlider.value)
          );
        };

        zoomSlider.oninput = async (e) => {
          const zoomValue = parseFloat(e.target.value);
          await startARWithDevice(videoDevices[currentDeviceIndex].deviceId, zoomValue);
        };
      }

      window.addEventListener("load", () => {
        if (
          !navigator.mediaDevices ||
          !navigator.mediaDevices.enumerateDevices ||
          !navigator.mediaDevices.getUserMedia
        ) {
          alert(
            "Seu navegador não suporta as APIs necessárias para trocar de câmera e controlar zoom."
          );
          return;
        }
        init();
      });
    </script>
  </body>
</html>
